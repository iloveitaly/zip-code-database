#!/usr/bin/env bash

set -eo pipefail

# This script downloads the 2020 ZCTA-to-Place relationship file and the Place Gazetteer,
# converts them into a ZIP -> CITY, STATE CSV using a Python script, and imports it into dolt.

cd "$(dirname "$(realpath "${BASH_SOURCE[0]}")")/../"
PROJECT_ROOT="$(pwd)"

DATA_DIR="${PROJECT_ROOT}/data"
CITY_STATE_DIR="${PROJECT_ROOT}/city_state"
RAW_DIR="${DATA_DIR}/raw_city_state"

mkdir -p "${RAW_DIR}"

echo "Working in ${PROJECT_ROOT}" >&2

# Download URLs (Census public)
# 1) 2020 ZCTA to Place Relationship file (direct TXT)
REL_TXT_URL="https://www2.census.gov/geo/docs/maps-data/data/rel2020/zcta520/tab20_zcta520_place20_natl.txt"
# 2) Place Gazetteer (use 2020 to match 2020 relationships)
PLACE_GAZ_URL="https://www2.census.gov/geo/docs/maps-data/data/gazetteer/2020_Gazetteer/2020_Gaz_place_national.zip"

pushd "${RAW_DIR}" >/dev/null

echo "Downloading ZCTA->Place relationship file..." >&2
curl -fL -o tab20_zcta520_place20_natl.txt "$REL_TXT_URL"

echo "Downloading Place Gazetteer..." >&2
curl -fL -o place_gaz.zip "$PLACE_GAZ_URL"

echo "Unzipping Place Gazetteer..." >&2
rm -f 2024_Gaz_place_national.txt || true
unzip -o place_gaz.zip

popd >/dev/null

echo "Converting to ZIP -> CITY, STATE mapping via Python..." >&2
python3 "${CITY_STATE_DIR}/convert_zcta_place_to_zip_city_state.py" \
  --rel-file "${RAW_DIR}/tab20_zcta520_place20_natl.txt" \
  --place-gaz-file "${RAW_DIR}/2020_Gaz_place_national.txt" \
  --out "${DATA_DIR}/zip_code_to_city_and_state.csv"

echo "Importing into dolt table zip_code_to_city_and_state..." >&2
dolt sql -q "DROP TABLE IF EXISTS zip_code_to_city_and_state;"
dolt table import -c -f --pk zip zip_code_to_city_and_state "${DATA_DIR}/zip_code_to_city_and_state.csv"

echo "Done. Output at ${DATA_DIR}/zip_code_to_city_and_state.csv" >&2
