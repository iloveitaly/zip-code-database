#!/bin/bash
# Downloads and processes the Census Bureau's ZCTA (ZIP Code Tabulation Area) Gazetteer file.
# This gets processed into a table with a pk added. This is the first script that should be run.
#
# A "gazetteer" is a geographical dictionary or directory - historically, a published list of place names
# with their locations. The term comes from the Italian "gazzetta" (a Venetian newspaper that published
# such lists). In modern usage, the Census Bureau uses "gazetteer" to refer to reference files that provide
# authoritative geographic data (coordinates, boundaries, etc.) for geographic entities like ZCTAs, places,
# and counties.
#
# This gazetteer contains geographic reference data including latitude, longitude, and other
# spatial information for each ZCTA. This data is used to map ZIP codes to their geographic
# coordinates and is a foundational dataset for the zip-code-database project.

set -eo pipefail

cd $(dirname "$(realpath "${BASH_SOURCE[0]}")")/../
PROJECT_ROOT="$(pwd)"
pwd

rm -rf data
mkdir data
pushd data

filename="input.zip"

http --download --output="$filename" --follow https://www2.census.gov/geo/docs/maps-data/data/gazetteer/2024_Gazetteer/2024_Gaz_zcta_national.zip

unzip "$filename"

mv *.txt gazetteer.txt

../bin/process-gazetteer gazetteer.txt >zip-codes.csv

rm input.zip gazetteer.txt
popd

# Drop the zip_codes database if it exists
dolt sql -q "DROP DATABASE IF EXISTS zip_codes;"

dolt table import -cf zip_codes data/zip-codes.csv
dolt sql --query 'ALTER TABLE zip_codes ADD UNIQUE(ZIP);'

# add a numbered pk to the table
cat <<EOF >data/temp.sql
-- 1. Create a temporary table
CREATE TABLE temp_zip_codes (
  id INT NOT NULL AUTO_INCREMENT,
  zip varchar(1023),
  lat float,
  lng float,
  population INT,
  PRIMARY KEY (id)
);

-- 2. Insert data from zip_codes into temp_zip_codes, ordering by ZIP
INSERT INTO temp_zip_codes (zip, lat, lng)
SELECT ZIP, LAT, LNG FROM zip_codes ORDER BY ZIP ASC;

-- -- 3. Drop the old table
DROP TABLE zip_codes;

-- -- 4. Rename temp_zip_codes to zip_codes
RENAME TABLE temp_zip_codes TO zip_codes;
EOF
dolt sql --file data/temp.sql
rm data/temp.sql

${PROJECT_ROOT}/bin/add-population-data

# now, let's generate some formats
rm -rf doltdump
dolt dump -f --no-create-db --file-name data/zip_codes
dolt dump -f --result-format csv
dolt dump -f --result-format json

# csv + json don't allow you to specify file type, at least with version 1.13.0
mv doltdump/zip_codes.csv doltdump/zip_codes_with_pk.csv
mv doltdump/* data/
rm -rf doltdump

dolt docs upload README.md readme.md
